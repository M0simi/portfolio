import os
from io import BytesIO

import google.generativeai as genai
from django.core.files.storage import default_storage
from PyPDF2 import PdfReader

from .models import KnowledgeBase  

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY", "").strip()
MODEL_NAME = os.getenv("GEMINI_MODEL", "gemini-1.5-flash").strip() 

if API_KEY:
    genai.configure(api_key=GEMINI_API_KEY)


def _read_latest_kb_text(max_chars: int = 60_000) -> str:
    """ููุฑุฃ ุฃุญุฏุซ ููู/ูุญุชูู ูู ูุงุนุฏุฉ ุงููุนุฑูุฉ ุนุจุฑ ุงูุชุฎุฒูู ุงููุนุฑูู (Cloudinary ุฃู ูุญูู)."""
    kb = KnowledgeBase.objects.order_by("-id").first()
    if not kb:
        return ""

    # ูู ุนูุฏู ุญูู ูุตูู ุฅุถุงูู (ูุซู content) ุงุณุชุฎุฏูู ุฃููุงู
    text = (getattr(kb, "content", "") or "").strip()
    if text:
        return text[:max_chars]

    # FileField (resource_type=raw ูู Cloudinary)
    f = getattr(kb, "file", None)
    if not f:
        return ""

    # ููุฑุฃ ุนุจุฑ default_storage ุนุดุงู ูุง ูุนุชูุฏ ุนูู ุฑูุงุจุท ุนุงูุฉ
    # ูุฐุง ุงูุณุทุฑ ูู ุงูุฐู ูุงู ูุณุจุจ ุฎุทุฃ 401 ุฃู v1beta
    with default_storage.open(f.name, "rb") as fh:
        data = fh.read()

    reader = PdfReader(BytesIO(data))
    parts = []
    for p in reader.pages:
        try:
            t = p.extract_text() or ""
        except Exception:
            t = ""
        if t:
            parts.append(t)
        if sum(len(x) for x in parts) >= max_chars:
            break

    return ("\n".join(parts))[:max_chars].strip()


def ask_gemini(user_prompt: str) -> str:
    """ููููุฏ ุฅุฌุงุจุฉ ุจุงูุงุณุชูุงุฏ ุฅูู ุฃุญุฏุซ ุฏููู/FAQ ูุฑููุน."""
    if not GEMINI_API_KEY:
        return "โ ููููุฏ ูุชุบูุฑ ุงูุจูุฆุฉ GEMINI_API_KEY."

    # --- (ูุฐุง ูู ุงูุฅุตูุงุญ ุงูููู) ---
    # ูุถุนูุง ูู ุดูุก ุฏุงุฎู try/except
    # ููุชููู ูู ุฑุคูุฉ ุงูุฎุทุฃ ุงูุญูููู (ุณูุงุก ูู ูุฑุงุกุฉ ุงูููู ุฃู ูู Gemini)
    try:
        # 1. ูุฑุงุกุฉ ุงูููู (ุชู ููููุง ูุฏุงุฎู ุงูู try)
        kb_text = _read_latest_kb_text()
        
        # 2. ุฅุนุฏุงุฏ ุงูููุฏููุงุช
        # (ูุณุชุฎุฏู ุงูููุฏูู ุงููุญุฏุฏุ ูุน ููุฏูู ุงุญุชูุงุทู ูุงุญุฏ)
        model_names = [MODEL_NAME, "gemini-1.5-flash"] 

        # 3. ุฅุนุฏุงุฏ ุงูุจุฑูุจุช (ุงูุงุญุชุฑุงูู)
        system_rule = (
            "ุฃูุช UniBot ๐ุ ุงููุณุงุนุฏ ุงูุฐูู ุงูุฑุณูู ูุฌุงูุนุชูุง."
            " ูููุชู ูู ุชูุฏูู ุฅุฌุงุจุงุช ุฏูููุฉ ูููุซููุฉ ููุทูุงุจ ุจุฃุณููุจ ุงุญุชุฑุงูู ูุฏุงุนู."
            
            "**ููุงุนุฏู ุงูุตุงุฑูุฉ ูู:**"
            "1.  ุงุณุชุฎุฏู **ุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู** ุฏุงุฆูุงู."
            "2.  ูุฌุจ ุฃู ุชุณุชูุฏ ุฌููุน ุฅุฌุงุจุงุชู **ุญุตุฑูุงู** ุนูู ุงููุนูููุงุช ุงููุชููุฑุฉ ูู ุฏููู ุงูุฌุงูุนุฉ (ุงููุต ุงูุชุงูู)."
            "3.  ูุฏูู ุงูุฅุฌุงุจุฉ ุจูุถูุญ ูุฅูุฌุงุฒุ ูุฑูุฒ ุนูู ุงูุฌุฒุก ุงููุชุนูู ุจุณุคุงู ุงูุทุงูุจ ูุจุงุดุฑุฉ."
            "4.  ูุง ุชุฎุชุฑุน ุฃู ูุนูููุฉ ุฃู ุฑุงุจุท ุฃู ุฑูู ูุงุชู ุบูุฑ ููุฌูุฏ ูู ุงููุต."
            
            "**ูู ุญุงู ูู ุชุฌุฏ ุงูุฅุฌุงุจุฉ:**"
            "ุฅุฐุง ูุงู ุงูุณุคุงู ุบูุฑ ููุฌูุฏ ุฅุทูุงูุงู ูู ุงููุตุ ุฃู ูุงู ุณุคุงูุงู ุนุงูุงู ุฎุงุฑุฌ ูุทุงู ุงูุฏูููุ ูุฌุจ ุฃู ูููู ุฑุฏู ููุฐุจุงู ูุงูุชุงูู:"
            "ยซุนุฐุฑูุงุ ุงููุนูููุฉ ุงูุชู ุชุจุญุซ ุนููุง ุบูุฑ ูุชููุฑุฉ ูู ุงูุฏููู ุงูุญุงูู. ููุญุตูู ุนูู ุชูุงุตูู ุฃุฏูุ ุฃูุตุญู ุจูุฑุงุฌุนุฉ ุงููุณู ุงููุฎุชุต ูู ุงูุฌุงูุนุฉ.ยป"
        )
        
        prompt = f"""{system_rule}

--- ููุชุทู ูู ุงูุฏููู/ุงูุฃุณุฆูุฉ ---
{kb_text if kb_text else "ูุง ูุชููุฑ ูุญุชูู ูุนุฑูุฉ ุญุงููุงู."}

--- ุณุคุงู ุงููุณุชุฎุฏู ---
{user_prompt}
"""

        # 4. ูุญุงููุฉ ุงูุงุชุตุงู ุจู Gemini
        last_err = None
        for name in model_names:
            try:
                model = genai.GenerativeModel(name)
                resp = model.generate_content(prompt)
                text = getattr(resp, "text", "") or ""
                text = text.strip()
                if not text:
                    text = "ุนุฐุฑูุงุ ุงููุนูููุฉ ุงูุชู ุชุจุญุซ ุนููุง ุบูุฑ ูุชููุฑุฉ ูู ุงูุฏููู ุงูุญุงูู. ููุญุตูู ุนูู ุชูุงุตูู ุฃุฏูุ ุฃูุตุญู ุจูุฑุงุฌุนุฉ ุงููุณู ุงููุฎุชุต ูู ุงูุฌุงูุนุฉ."
                return text  # ูุฌุญูุง
            except Exception as e:
                last_err = e
                continue  # ุฌุฑูุจ ุงูููุฏูู ุงูุงุญุชูุงุทู
        
        # ุฅุฐุง ูุดูุช ูู ุงูููุฏููุงุช
        return f"โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู Gemini: {last_err}"

    except Exception as e:
        # ูุฐุง ูู ุงูุณุทุฑ ุงูุฃูู: ุณููุณู ุงูุฃุฎุทุงุก ุงูุชู ุชุญุฏุซ "ูุจู" ุงูุงุชุตุงู
        # (ูุซู ุฎุทุฃ ูุฑุงุกุฉ ุงูููู 401 ุฃู ุฎุทุฃ v1beta 404)
        return f"โ๏ธ ุฎุทุฃ ูู ุงูุฅุนุฏุงุฏ ุฃู ูุฑุงุกุฉ ุงูููู: {e}"
